<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>CheerpJ test</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cjrtnc.leaningtech.com/3_20240110_341/cj3loader.js"></script>
    <!--<style>
        .as-console-wrapper {
            z-index: 500000 !important;
        }
    </style>-->
    <style>
        html, body {
            margin: 0;
        }
    
        #container {
            width: 100vw;
            height: 100svh;
        }
    </style>
</head>
<body>
    <div id="container">
        <label>
            SWF File Upload:
            <input type="file" accept=".swf" oninput="window.handleFiles(this)">
        </label>
    </div>

    <script type="module">
        const supportsClipboardAPI = 
            window.isSecureContext 
            && await navigator
                .permissions
                .query({ name: "clipboard-read" })
                .then(() => true) // Browser does support
                .catch(() => false); // No browser support
        const urlParams = new URLSearchParams(window.location.search);

        async function initConsole() {
            if(window.location.hash !== "#console") {
                window.addEventListener("hashchange", initConsole, { once: true });
                return;
            }
            
            await import("https://cdn.jsdelivr.net/npm/eruda@3/eruda.js");
            await eruda.init();
        }
        await initConsole();


        /*class Inotify {
            static descriptors = [
                "/dev/stdin", // 0
                "/dev/stdout", // 1
                "/dev/stderr", // 2
            ];

        }

        const FileUtils = {
            // Returns promise resolving to a blob 
            readFile: path => 
                cjFileBlob(path),
            addFile: (path, content) => cheerpOSAddStringFile(
                path, 
                content
            ),
        };*/


        console.groupCollapsed("Initializing...");
        await cheerpjInit({
            javaProperties: [
                "java.net.preferIPv4Stack=true",
                //"java.vm.name=cheerpj",
            ],
            /*preloadResources: {},*/
            preloadProgress: (preloadDone, preloadTotal) => {
                console.info(`Loaded ${((preloadDone / preloadTotal) * 100).toFixed(5)}% (${preloadDone}/${preloadTotal})`);
            },
            clipboardMode: supportsClipboardAPI === true ? "permission" : "system",
            ...(!urlParams.get("base") 
                ? {}  
                : { overrideDocumentBase: urlParams.get("base") }
            ),
            beepCallback: () => alert("Beep!"),
            enableInputMethods: true,
            /*natives: {},*/
        });
        console.groupEnd();

        window.handleFiles = async element => {
            const file = element.files[0];
            const buff = await file.arrayBuffer();
            const { name } = file;

            cheerpOSAddStringFile(`/str/${name}`, new Uint8Array(buff));
            runApp(name);
        };
        
        async function runApp(fileName) {
            const container = document.querySelector("#container");
            container.replaceChildren(); // Delete contents
            cheerpjCreateDisplay(-1, -1, container);
            console.log("Created display...");
            

            console.group("Running...");
            const exitCode = await cheerpjRunJar("/app/ffdec.jar", `/str/${fileName}`);
            
            console.log(`Exited with code: ${exitCode}`);
            console.groupEnd();
        };
    </script>
</body>
</html>
